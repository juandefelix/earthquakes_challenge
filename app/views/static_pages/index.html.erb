<div class="container">
  <div class="row">
    <div id="search" class='col-xs-10 col-xs-offset-1'>
      <h1>Look for recent earthquakes with GeoNames</h1>
      <%= label_tag(:q, "Enter the name of a city:") %>
      <%= text_field_tag(:q, 'Tokio') %><br>
      <button type="button" class="btn btn-info"> find earthquakes near this location</button>
    </div>
  </div>
</div>
<div class="col-xs-8 col-xs-offset-2">
  <div id='map-container'>
    <div id="map-canvas"></div>
  </div>
</div>

<script>

  var map;
  
  $('#map-canvas').hide();


  function initialize() {
    var mapOptions = {
      center: new google.maps.LatLng(-34.397, 150.644),
      zoom: 4
    };
    map = new google.maps.Map(document.getElementById("map-canvas"),
        mapOptions);
  }

  google.maps.event.addDomListener(window, 'load', initialize);

  $("button").click(function(){
    
    var lng;
    var lat;

    var city = $("input[type=text]").val()
    var url_string = 'http://maps.google.com/maps/api/geocode/json?address='
    var location_url = url_string + city + "&sensor=false"


    $.getJSON(location_url, function(data){

      lat = data['results']['0']['geometry']['location']['lat']
      lng = data['results']['0']['geometry']['location']['lng']
      console.log(lng)

      map.setCenter({lat: lat, lng: lng});

      var north = data['results']['0']['geometry']['bounds']['northeast']['lat'] + 1
      var south = data['results']['0']['geometry']['bounds']['southwest']['lat'] - 1
      var east  = data['results']['0']['geometry']['bounds']['northeast']['lng'] - 1
      var west  = data['results']['0']['geometry']['bounds']['southwest']['lng'] + 1

      var earthquakes_string = "http://api.geonames.org/earthquakesJSON?"
      var earthquakes_url = earthquakes_string + "north=" + north + "&south=" + south + "&east=" + east + "&west=" + west + "&username=juandefelix"

      $.getJSON(earthquakes_url, function(data){

        var ary = data['earthquakes']

        infoWindow = new google.maps.InfoWindow({
          content: "holding..."
        });

        for(i = 0; i < ary.length; i++){

          lat = ary[i]['lat']
          longitude = ary[i]['lng']
          depth = ary[i]['depth']
          magnitude = ary[i]['magnitude']

          marker = new google.maps.Marker({
            position: new google.maps.LatLng(lat,longitude),
            map: map,
            title: 'Hello World!'
          });

          var contentArray = '<div id="content">'+
            '<div id="siteNotice">'+
            '</div>'+
            '<h3 id="firstHeading" class="firstHeading">Earthquake ' + i + '</h1>'+
            '<div id="bodyContent">'+
            '<p><b>latitude: </b>' + lat + '</p>'+
            '<p><b>longitude: </b>' + longitude + '</p>'+
            '<p><b>depth: </b>' + depth + '</p>'+
            '<p><b>magnitude: </b>' + magnitude + '</p>'+
            '</div>'+
            '</div>';
            
          bindInfoWindow(marker, map, infoWindow, contentArray);
        }

      function bindInfoWindow(marker, map, infowindow, strDescription) {
        google.maps.event.addListener(marker, 'click', function() {
            infowindow.setContent(strDescription);
            infowindow.open(map, marker);
        });
      }
        google.maps.event.trigger(map, 'resize');
        $('#map-canvas').show();
      }) // end second ajax
    }) // end first ajax
  }) // end click
</script>
