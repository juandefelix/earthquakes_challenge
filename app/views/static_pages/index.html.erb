<div class="container">
  <div class="row">
    <div id="search" class='col-xs-10 col-xs-offset-1'>
      <h2>Look for recent earthquakes. Click on the markers for details</h2>
      <%= label_tag(:q, "Enter the name of a city:") %>
      <%= text_field_tag(:q, 'Tokio') %><br>
      <button type="button" class="btn btn-info" id= "button1"> find earthquakes near this location</button>
      <button type="button" class="btn btn-info" id="button2"> 10 biggest earthquakes on Earth</button>
    </div>
  </div>
</div>
<div class="col-xs-8 col-xs-offset-2">
  <div id="map-canvas"></div>
</div>

<script>

  var map;
  
  function initialize() {
    var mapOptions = {
      center: new google.maps.LatLng(-34.397, 150.644),
      zoom: 4
    };
    map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
  }

  google.maps.event.addDomListener(window, 'load', initialize);

  $("#button1").click(function(){
    var lng;
    var lat;

    var city = $("input[type=text]").val()
    var url_string = 'http://maps.google.com/maps/api/geocode/json?address='
    var location_url = url_string + city + "&sensor=false"


    $.getJSON(location_url, function(data){

      lat = data['results']['0']['geometry']['location']['lat']
      lng = data['results']['0']['geometry']['location']['lng']
      console.log(lng)

      map.setCenter({lat: lat, lng: lng});

      var north = data['results']['0']['geometry']['bounds']['northeast']['lat'] + 1
      var south = data['results']['0']['geometry']['bounds']['southwest']['lat'] - 1
      var east  = data['results']['0']['geometry']['bounds']['northeast']['lng'] + 1
      var west  = data['results']['0']['geometry']['bounds']['southwest']['lng'] - 1

      var earthquakes_string = "http://api.geonames.org/earthquakesJSON?"
      var earthquakes_url = earthquakes_string + "north=" + north + "&south=" + south + "&east=" + east + "&west=" + west + "&username=juandefelix"

      $.getJSON(earthquakes_url, function(data){

        var ary = data['earthquakes']

        infoWindow = new google.maps.InfoWindow({
          content: "holding..."
        });

        for(i = 0; i < ary.length; i++){

          lat = ary[i]['lat']
          longitude = ary[i]['lng']
          depth = ary[i]['depth']
          magnitude = ary[i]['magnitude']

          marker = new google.maps.Marker({
            position: new google.maps.LatLng(lat,longitude),
            map: map,
            title: 'Hello World!'
          });

          var contentArray = '<div id="content">'+
            '<div id="siteNotice">'+
            '</div>'+
            '<h3 id="firstHeading" class="firstHeading">Earthquake ' + (i + 1) + '</h1>'+
            '<div id="bodyContent">'+
            '<p><b>latitude: </b>' + lat + '</p>'+
            '<p><b>longitude: </b>' + longitude + '</p>'+
            '<p><b>depth: </b>' + depth + '</p>'+
            '<p><b>magnitude: </b>' + magnitude + '</p>'+
            '</div>'+
            '</div>';
            
          bindInfoWindow(marker, map, infoWindow, contentArray);
        }

        function bindInfoWindow(marker, map, infowindow, strDescription) {
          google.maps.event.addListener(marker, 'click', function() {
              infowindow.setContent(strDescription);
              infowindow.open(map, marker);
          });
        }
      }) // end second ajax
    }) // end first ajax
  }) // end click

  // format the date
  var dateTime = new Date();
  var isoDate = dateTime.toISOString()
  var formattedTime = isoDate.match(/\d{4}-\d{2}-\d{2}/)[0]

  //string for the geonames request
  var recentEarthquakesStr = 'http://api.geonames.org/earthquakesJSON?north=90&south=-90&east=90&west=-90&maxRows=10&username=juandefelix&date=' + formattedTime

  $("#button2").click(function(){
    $.getJSON(recentEarthquakesStr, function(data){
      var earthqList = []
      $.each(data['earthquakes'], function(i, item) {

          var depth = item['depth']
          var magn = item['magnitude']
          var date = item['datetime'].match(/\d{4}-\d{2}-\d{2}/)[0]

          earthqList.push('<li><b>date: </b>'+ date +  
                     '<b> magnitude: </b>'+ magn + 
                     '<b> depth: </b>' + depth +'</li>');
      });  // close each()
      $('body').append( earthqList.join('') )
    })
  })
</script>
